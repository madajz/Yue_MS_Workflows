---
title: "HFD - Striatum Lipids"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,warnings=F,error = F)

library(ggplot2)
library(ggforce)
library(limma)
library(dplyr)
library(ggrepel)
library(imputeLCMD)
library(ggsci)
library(factoextra)
library(emmeans)
library(patchwork)
library(pheatmap)
library(brglm2)
library(readxl)

```


# Section {.tabset}

## Read in data {.tabset}

```{r, include=F}

## Please select the path to the data file you want to analyze
data = read.csv("~/bbc-secondary/research/MOOD_yue_MS_template_VBCS1110/230907_MC00422_profiling_PlasmaLipidomics/2_tables/MC00422_Merged_PoolSize.csv",header=T)

## Update the file path for the Excel file with Sex info, this will need to  be merged into these files since the MS files don't seem to have sex info
meta = subset(readxl::read_excel("~/bbc-secondary/research/MOOD_yue_MS_template_VBCS1110/sample submittion_20231030_Banana_HFD aged.xlsx",sheet=3,skip=1),select=c('Core ID','Condition 3'))
colnames(meta) = c("ID","Sex")
meta$ID = paste0("S",meta$ID)
meta$Sex = toupper(meta$Sex)
colnames(data)[1] = "Sample"

# This line makes all of the compound variables numeric, sometimes they read in as characters
data[,2:ncol(data)] <- sapply( data[,2:ncol(data)], as.numeric )


if(any(grepl("blank",tolower(data$Sample),fixed=T))){
  # Now we'll do blank filtering
  # Start by making a data.frame of just the blank which we'll use for subtraction
  blank = log2(data[grepl("blank",tolower(data$Sample),fixed=T),-1])
  
  #Make all missing and -Inf values 0 for the purposes of easily checking for > 3 fold difference
  blank[which(apply(blank,2,function(x) sum(is.finite(x)))<1)] = 0
  
  #Substract actual valus from blank values, both on the log2 scale
  diff = as.data.frame(t(log2(t(data[,2:ncol(data)])) - as.vector(t(blank))))
  
  #Any difference that is less than 3 fold, make missing
  data[,2:ncol(data)][which(diff < log2(3),arr.ind=T)] = NA
}
#remove QC and process blanks
data = data[! (grepl("qc",tolower(data$Sample),fixed=T) |grepl("blank",tolower(data$Sample),fixed=T)) , ]

Molecule = colnames(data)[2:ncol(data)]

# Looking for diet, genotypes; where is the sex information?
data$Geno_Diet =  sapply(strsplit(data$Sample,"_"), function(x) x[2])
data$Geno = tolower(gsub("-.*","",data$Geno_Diet))
data$Diet = gsub(".*-","",data$Geno_Diet)
data$ID = gsub("_.*","",data$Sample)

data = left_join(data,meta,by="ID")


table(data$Geno,data$Diet,data$Sex)

data = subset(data, select= - c(Geno_Diet))



```



### Missingness

Here we create a heatmap of missingness to see if it specific to any group of interest (Diet, Genotype). If there is any specificity, you would see very clear clustering blocks. If nothing shows up, there were no missing values


```{r, fig.height = 9,fig.width=9}
#Replace 0s with NA
data[data==0]=NA

miss.df = data
rownames(miss.df) = miss.df$Sample
miss.df = miss.df[,colnames(miss.df) %in% Molecule]
miss.df[!is.na(miss.df)] = 1
miss.df[is.na(miss.df)] = 0

missing = apply(miss.df,2, function(x) sum(x)/length(x))
anno = data.frame(Genotype = data$Geno,Diet = data$Diet,Sex=data$Sex)
rownames(anno) = rownames(miss.df)

if( length(which(missing<0.95)) > 0){
  pheatmap(t(miss.df[,which(missing<0.95)
  ]),color=c("white","black"),annotation_col = anno)
}

```


### Testing for specificity

There are not enough samples to really startify by sex and test for specificty, so this analysis only adjusts for sex

```{r, include=F}

miss.df$Geno = data$Geno
miss.df$Diet = data$Diet
miss.df$Sex = data$Sex
colnames(miss.df) = make.names(colnames(miss.df))
res.diet=NULL
res.geno=NULL
res.delta.delta=NULL

for(i in colnames(miss.df[,which(missing<0.95)])){
  
  f=as.formula(paste0(i,"~ Diet*Geno"))
  fit = glm(f, data = miss.df, family = "binomial", method = brglmFit)
  
  res.diet = rbind(res.diet,data.frame(Compound = i,summary(emmeans(fit,pairwise~Diet|Geno,adjust="none")$contrasts)))
  
  res.geno = rbind(res.geno,data.frame(Compound = i,summary(emmeans(fit,pairwise~Geno|Diet,adjust="none")$contrasts)))
  
  res.delta.delta = rbind(res.delta.delta,data.frame(Compound = i,joint_tests(fit)[3,]))
  res.delta.delta$model.term = "Delta - Delta"

}


res.geno$FDR = p.adjust(res.geno$p.value,method="BH")

res.diet$FDR = p.adjust(res.diet$p.value,method="BH")

res.delta.delta$FDR = p.adjust(res.delta.delta$p.value,method="BH")



```

#### If rows are empty or nothing is showing, no specificty was detected

```{r}

if(length(colnames(miss.df[,which(missing<0.95)]))>0){

  knitr::kable(res.diet[res.diet$FDR < 0.1,],caption="Compounds specific to a Diet")
  knitr::kable(res.geno[res.geno$FDR < 0.1,],caption="Compounds specific to a Genotype")
  knitr::kable(res.delta.delta[res.delta.delta$FDR < 0.1,],caption="Compounds specific to a Diet/Genotype Combo")
}


```

### Removed for too much missgingness

```{r}
#These compounds are being removed for excessive missingness
knitr::kable(names(missing[missing<0.3]))

#drop heavily missing data (>30%)
data = data[, ! colnames(data) %in% names(missing[missing<0.3])]

```


```{r}

#impute
data[,colnames(data) %in% Molecule] = t(imputeLCMD::impute.QRILC(log2(t(data[,colnames(data) %in% Molecule])))[[1]])


```

## Exploratory {.tabset}

### PCA

```{r, fig.height=6,fig.width=16}

pc.plot = function(df){

  pc = prcomp(data.matrix(df[,colnames(df) %in% Molecule]))

  pc.df = as.data.frame(pc$x)
  pc.df$Genotype = df$Geno
  pc.df$Diet = df$Diet

  p1 = ggplot(pc.df,aes(x=PC1,y=PC2,color = Diet,shape=Genotype, linetype=Genotype )) +
    geom_point() +
    geom_mark_ellipse() +
    theme_bw(12) +
    scale_color_nejm()

  p2 = ggplot(pc.df,aes(x=PC3,y=PC4,color = Diet,shape=Genotype, linetype=Genotype )) +
    geom_point() +
    geom_mark_ellipse() +
    theme_bw(12) +
    scale_color_nejm()

  p3 = ggplot(pc.df,aes(x=PC5,y=PC6,color = Diet,shape=Genotype, linetype=Genotype )) +
    geom_point() +
    geom_mark_ellipse() +
    theme_bw(12) +
    scale_color_nejm()

  print(p1+p2+p3)

}

pc.plot(data) +  plot_annotation('Pooled Sexes',theme=theme(plot.title=element_text(hjust=0.5)))


pc.plot(data[toupper(data$Sex) == "M",]) +  plot_annotation('Males Only',theme=theme(plot.title=element_text(hjust=0.5)))

pc.plot(data[toupper(data$Sex) == "F",]) +  plot_annotation('Females Only',theme=theme(plot.title=element_text(hjust=0.5)))

```



### Heatmap {.tabset}

#### Pooled

```{r, fig.width=9,fig.height=25}

anno = data.frame(Genotype = data$Geno, data$Diet,Sex = data$Sex)
rownames(anno) = data$Sample
rownames(data) = data$Sample
pheatmap(t(log2(data[,colnames(data) %in% Molecule])),
         annotation_col = anno,
         scale="row",
         color=colorRampPalette(c("blue","white","red"))(100))


```


#### Males Only

```{r, fig.width=9,fig.height=25}

anno = data.frame(Genotype = data[data$Sex == "M",]$Geno,Diet = data[data$Sex == "M",]$Diet)
rownames(anno) = data[data$Sex == "M",]$Sample

pheatmap(t(log2(data[data$Sex == "M",colnames(data) %in% Molecule])),
         annotation_col = anno,
         scale="row",
         color=colorRampPalette(c("blue","white","red"))(100))



```



#### Females Only

```{r, fig.width=9,fig.height=25}

anno = data.frame(Genotype = data[data$Sex == "F",]$Geno,Diet = data[data$Sex == "F",]$Diet)
rownames(anno) = data[data$Sex == "F",]$Sample

pheatmap(t(log2(data[data$Sex == "F",colnames(data) %in% Molecule])),
         annotation_col = anno,
         scale="row",
         color=colorRampPalette(c("blue","white","red"))(100))



```


## Differntial Abundance {.tabset}

### Pooled {.tabset}

```{r, fig.height=14,fig.width=14}


data$Geno_Diet = paste0(data$Geno,data$Diet)

design = model.matrix(~ 0 + Geno_Diet + Sex, data= data)


fit <- lmFit(t(data[,colnames(data) %in% Molecule]), design, robust = TRUE)

cont2 = makeContrasts( Geno_DietkiHFD - Geno_DietwtHFD ,
                       Geno_DietkiLFD- Geno_DietwtLFD,
                       (Geno_DietkiHFD - Geno_DietwtHFD) -
                         (Geno_DietkiLFD- Geno_DietwtLFD),
                       Geno_DietkiHFD - Geno_DietkiLFD,
                       Geno_DietwtHFD - Geno_DietwtLFD,
                       levels = design)

set.seed(777)
fit.cont <- contrasts.fit(fit, contrasts = cont2) 

set.seed(777)
ebayesf <- eBayes(fit.cont, robust = T, trend = T)

tops.sig = topTable(ebayesf, adjust.method = "BH", p.value = 0.05, number = Inf)
tops.all = topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf)
```

#### HFD KI - HFD WT

```{r, fig.height=9,fig.width=9}

hfd.df = data.frame(Contrast = "KI HFD vs WT HFD", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=1))
hfd.df$Compound = rownames(hfd.df)
hfd.df$Significant = ifelse(hfd.df$adj.P.Val<0.05,"Significant","NS")
hfd.df$label = ifelse(hfd.df$Significant == "NS","",hfd.df$Compound)

ggplot(hfd.df,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = hfd.df[hfd.df$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("HFD KI - WT")

knitr::kable(hfd.df[hfd.df$adj.P.Val<1,],row.names = F,digits = 4)


```


#### LFD KI - HFD WT

```{r, fig.height=9,fig.width=9}

lfd.df = data.frame(Contrast = "KI lfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=2))
lfd.df$Compound = rownames(lfd.df)
lfd.df$Significant = ifelse(lfd.df$adj.P.Val<0.05,"Significant","NS")
lfd.df$label = ifelse(lfd.df$Significant == "NS","",lfd.df$Compound)

ggplot(lfd.df,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = lfd.df[lfd.df$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("LFD KI - WT")

knitr::kable(lfd.df[lfd.df$adj.P.Val<1,],row.names = F,digits = 4)


```



####  [KI HFD vs. LFD] vs. [WT HFD vs. LFD]

```{r, fig.height=9,fig.width=9}

delta.delta.hfd = data.frame(Contrast = "Delta-Delta", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=3))
delta.delta.hfd$Compound = rownames(delta.delta.hfd)
delta.delta.hfd$Significant = ifelse(delta.delta.hfd$adj.P.Val<0.05,"Significant","NS")
delta.delta.hfd$label = ifelse(delta.delta.hfd$Significant == "NS","",delta.delta.hfd$Compound)

ggplot(delta.delta.hfd,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = delta.delta.hfd[delta.delta.hfd$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("[HFD: KI - WT] - [LFD: KI - WT]")

knitr::kable(delta.delta.hfd[delta.delta.hfd$adj.P.Val<1,],row.names = F,digits = 4)


```


####  KI HFD - KI LFD

```{r, fig.height=9,fig.width=9}

kihl.df = data.frame(Contrast = "KI hfd vs KI lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=4))
kihl.df$Compound = rownames(kihl.df)
kihl.df$Significant = ifelse(kihl.df$adj.P.Val<0.05,"Significant","NS")
kihl.df$label = ifelse(kihl.df$Significant == "NS","",kihl.df$Compound)

ggplot(kihl.df,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = kihl.df[kihl.df$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("KI HFD - KI HFD")

knitr::kable(kihl.df[kihl.df$adj.P.Val<1,],row.names = F,digits = 4)


```


####  WT HFD - WT LFD

```{r, fig.height=9,fig.width=9}

wthl.df = data.frame(Contrast = "WT hfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=5))
wthl.df$Compound = rownames(wthl.df)
wthl.df$Significant = ifelse(wthl.df$adj.P.Val<0.05,"Significant","NS")
wthl.df$label = ifelse(wthl.df$Significant == "NS","",wthl.df$Compound)

ggplot(wthl.df,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = wthl.df[wthl.df$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("WT HFD - WT LFD")

knitr::kable(wthl.df[wthl.df$adj.P.Val<1,],row.names = F,digits = 4)


```



#### Boxplots Top Compounds

```{r, fig.height=12,fig.width=16}


  plot.df = reshape2::melt(data[,colnames(data) %in% c("Geno","Diet",rownames(tops.all)[1:20])],id.vars=c("Geno","Diet"))
  title = "Boxplots of Compounds with largest differences"



ggplot( plot.df,aes(x = Geno,y=value,color=Diet)) +geom_boxplot(position = position_dodge()) +
  facet_wrap(~variable,scales="free_y")+theme_bw(16)+scale_color_aaas()+ggtitle(title)

```


### Males {.tabset}

```{r, fig.height=14,fig.width=14}

design = model.matrix(~ 0 + Geno_Diet , data= data[data$Sex == "M", ])


fit <- lmFit(t(data[data$Sex == "M",colnames(data) %in% Molecule]), design, robust = TRUE)

cont2 = makeContrasts( Geno_DietkiHFD - Geno_DietwtHFD ,
                       Geno_DietkiLFD- Geno_DietwtLFD,
                       (Geno_DietkiHFD - Geno_DietwtHFD) -
                         (Geno_DietkiLFD- Geno_DietwtLFD),
                       Geno_DietkiHFD - Geno_DietkiLFD,
                       Geno_DietwtHFD - Geno_DietwtLFD,
                       levels = design)
set.seed(777)
fit.cont <- contrasts.fit(fit, contrasts = cont2) 

set.seed(777)
ebayesf <- eBayes(fit.cont, robust = T, trend = T)

tops.sig = topTable(ebayesf, adjust.method = "BH", p.value = 0.05, number = Inf)
tops.all = topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf)
```

#### HFD KI - HFD WT

```{r, fig.height=9,fig.width=9}

hfd.df.m = data.frame(Contrast = "KI HFD vs WT HFD", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=1))
hfd.df.m$Compound = rownames(hfd.df.m)
hfd.df.m$Significant = ifelse(hfd.df.m$adj.P.Val<0.05,"Significant","NS")
hfd.df.m$label = ifelse(hfd.df.m$Significant == "NS","",hfd.df.m$Compound)

ggplot(hfd.df.m,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = hfd.df.m[hfd.df.m$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("HFD KI - WT")

knitr::kable(hfd.df.m[hfd.df.m$adj.P.Val<1,],row.names = F,digits = 4)


```


#### LFD KI - LFD WT

```{r, fig.height=9,fig.width=9}

lfd.df.m = data.frame(Contrast = "KI lfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=2))
lfd.df.m$Compound = rownames(lfd.df.m)
lfd.df.m$Significant = ifelse(lfd.df.m$adj.P.Val<0.05,"Significant","NS")
lfd.df.m$label = ifelse(lfd.df.m$Significant == "NS","",lfd.df.m$Compound)

ggplot(lfd.df.m,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = lfd.df.m[lfd.df.m$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("LFD KI - WT")

knitr::kable(lfd.df.m[lfd.df.m$adj.P.Val<1,],row.names = F,digits = 4)


```



####  [KI HFD vs. LFD] vs. [WT HFD vs. LFD]

```{r, fig.height=9,fig.width=9}

detla.delta.df.m = data.frame(Contrast = "Delta-Delta", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=3))
detla.delta.df.m$Compound = rownames(detla.delta.df.m)
detla.delta.df.m$Significant = ifelse(detla.delta.df.m$adj.P.Val<0.05,"Significant","NS")
detla.delta.df.m$label = ifelse(detla.delta.df.m$Significant == "NS","",detla.delta.df.m$Compound)

ggplot(detla.delta.df.m,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = detla.delta.df.m[detla.delta.df.m$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("[HFD: KI - WT] - [LFD: KI - WT]")

knitr::kable(detla.delta.df.m[detla.delta.df.m$adj.P.Val<1,],row.names = F,digits = 4)


```


####  KI HFD - KI LFD

```{r, fig.height=9,fig.width=9}

kihl.df.m = data.frame(Contrast = "KI hfd vs KI lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=4))
kihl.df.m$Compound = rownames(kihl.df.m)
kihl.df.m$Significant = ifelse(kihl.df.m$adj.P.Val<0.05,"Significant","NS")
kihl.df.m$label = ifelse(kihl.df.m$Significant == "NS","",kihl.df.m$Compound)

ggplot(kihl.df.m,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = kihl.df.m[kihl.df.m$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("KI HFD - KI HFD")

knitr::kable(kihl.df.m[kihl.df.m$adj.P.Val<1,],row.names = F,digits = 4)


```


####  WT HFD - WT LFD

```{r, fig.height=9,fig.width=9}

wthl.df.m = data.frame(Contrast = "WT hfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=5))
wthl.df.m$Compound = rownames(wthl.df.m)
wthl.df.m$Significant = ifelse(wthl.df.m$adj.P.Val<0.05,"Significant","NS")
wthl.df.m$label = ifelse(wthl.df.m$Significant == "NS","",wthl.df.m$Compound)

ggplot(wthl.df.m,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = wthl.df.m[wthl.df.m$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("WT HFD - WT LFD")

knitr::kable(wthl.df.m[wthl.df.m$adj.P.Val<1,],row.names = F,digits = 4)


```



#### Boxplots Top Compounds

```{r, fig.height=12,fig.width=16}


plot.df = reshape2::melt(data[data$Sex == "M",colnames(data) %in% c("Geno","Diet",rownames(tops.all)[1:20])],id.vars=c("Geno","Diet"))
title = "Boxplots of Compounds with largest differences"


ggplot( plot.df,aes(x = Geno,y=value,color=Diet)) +geom_boxplot(position = position_dodge()) +
  facet_wrap(~variable,scales="free_y")+theme_bw(16)+scale_color_aaas()+ggtitle(title)

```

### Females {.tabset}

```{r, fig.height=14,fig.width=14}

design = model.matrix(~ 0 + Geno_Diet , data= data[data$Sex == "F", ])


fit <- lmFit(t(data[data$Sex == "F",colnames(data) %in% Molecule]), design, robust = TRUE)

cont2 = makeContrasts( Geno_DietkiHFD - Geno_DietwtHFD ,
                       Geno_DietkiLFD- Geno_DietwtLFD,
                       (Geno_DietkiHFD - Geno_DietwtHFD) -
                         (Geno_DietkiLFD- Geno_DietwtLFD),
                       Geno_DietkiHFD - Geno_DietkiLFD,
                       Geno_DietwtHFD - Geno_DietwtLFD,
                       levels = design)

set.seed(777)
fit.cont <- contrasts.fit(fit, contrasts = cont2) 

set.seed(777)
ebayesf <- eBayes(fit.cont, robust = T, trend = T)

tops.sig = topTable(ebayesf, adjust.method = "BH", p.value = 0.05, number = Inf)
tops.all = topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf)
```

#### HFD KI - HFD WT

```{r, fig.height=9,fig.width=9}

hfd.df.f = data.frame(Contrast = "KI HFD vs WT HFD", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=1))
hfd.df.f$Compound = rownames(hfd.df.f)
hfd.df.f$Significant = ifelse(hfd.df.f$adj.P.Val<0.05,"Significant","NS")
hfd.df.f$label = ifelse(hfd.df.f$Significant == "NS","",hfd.df.f$Compound)

ggplot(hfd.df.f,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = hfd.df.f[hfd.df.f$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("HFD KI - WT")

knitr::kable(hfd.df.f[hfd.df.f$adj.P.Val<1,],row.names = F,digits = 4)


```


#### LFD KI - LFD WT

```{r, fig.height=9,fig.width=9}

ldf.df.f = data.frame(Contrast = "KI lfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=2))
ldf.df.f$Compound = rownames(ldf.df.f)
ldf.df.f$Significant = ifelse(ldf.df.f$adj.P.Val<0.05,"Significant","NS")
ldf.df.f$label = ifelse(ldf.df.f$Significant == "NS","",ldf.df.f$Compound)

ggplot(ldf.df.f,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = ldf.df.f[ldf.df.f$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("LFD KI - WT")

knitr::kable(ldf.df.f[ldf.df.f$adj.P.Val<1,],row.names = F,digits = 4)


```



####  [KI HFD vs. LFD] vs. [WT HFD vs. LFD]

```{r, fig.height=9,fig.width=9}

delta.delta.df = data.frame(Contrast = "Delta-Delta", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=3))
delta.delta.df$Compound = rownames(delta.delta.df)
delta.delta.df$Significant = ifelse(delta.delta.df$adj.P.Val<0.05,"Significant","NS")
delta.delta.df$label = ifelse(delta.delta.df$Significant == "NS","",delta.delta.df$Compound)

ggplot(delta.delta.df,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = delta.delta.df[delta.delta.df$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("[HFD: KI - WT] - [LFD: KI - WT]")

knitr::kable(delta.delta.df[delta.delta.df$adj.P.Val<1,],row.names = F,digits = 4)


```

####  KI HFD - KI LFD

```{r, fig.height=9,fig.width=9}

kihl.df.f = data.frame(Contrast = "KI hfd vs KI lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=4))
kihl.df.f$Compound = rownames(kihl.df.f)
kihl.df.f$Significant = ifelse(kihl.df.f$adj.P.Val<0.05,"Significant","NS")
kihl.df.f$label = ifelse(kihl.df.f$Significant == "NS","",kihl.df.f$Compound)

ggplot(kihl.df.f,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = kihl.df.f[kihl.df.f$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("KI HFD - KI HFD")

knitr::kable(kihl.df.f[kihl.df.f$adj.P.Val<1,],row.names = F,digits = 4)


```


####  WT HFD - WT LFD

```{r, fig.height=9,fig.width=9}

wthl.df.f = data.frame(Contrast = "WT hfd vs WT lfd", topTable(ebayesf, adjust.method = "BH", p.value = 1, number = Inf,coef=5))
wthl.df.f$Compound = rownames(wthl.df.f)
wthl.df.f$Significant = ifelse(wthl.df.f$adj.P.Val<0.05,"Significant","NS")
wthl.df.f$label = ifelse(wthl.df.f$Significant == "NS","",wthl.df.f$Compound)

ggplot(wthl.df.f,aes(x=logFC,y=-log10(adj.P.Val),color=Significant)) + geom_point()+
  theme_bw(16) +facet_wrap(~Contrast)+geom_text_repel(data = wthl.df.f[wthl.df.f$label!= "",] ,aes(label=Compound))+scale_color_manual(values = c("NS"="black","Significant" = "red")) + ggtitle("WT HFD - WT LFD")

knitr::kable(wthl.df.f[wthl.df.f$adj.P.Val<1,],row.names = F,digits = 4)


```


#### Boxplots Top Compounds

```{r, fig.height=12,fig.width=16}


plot.df = reshape2::melt(data[data$Sex == "F",colnames(data) %in% c("Geno","Diet",rownames(tops.all)[1:20])],id.vars=c("Geno","Diet"))
title = "Boxplots of Compounds with largest differences"

ggplot( plot.df,aes(x = Geno,y=value,color=Diet)) +geom_boxplot(position = position_dodge()) +
  facet_wrap(~variable,scales="free_y")+theme_bw(16)+scale_color_aaas()+ggtitle(title)

```
